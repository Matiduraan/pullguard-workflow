name: PR Check

on:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: true

jobs:
  pr-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      id-token: write # OBLIGATORIO para OIDC

    steps:
      - name: Request quiz status
        id: check-status
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SHA: ${{ github.event.pull_request.head.sha }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          OIDC_TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=tu-backend" \
            | jq -r '.value')

          RESPONSE=$(curl -s -X GET \
            "https://more-rationally-fawn.ngrok-free.app/api/quiz/${OWNER}/${REPO_NAME}/${PR_NUMBER}/status?headSha=${SHA}" \
            -H "Authorization: Bearer $OIDC_TOKEN")

          echo "Backend response: $RESPONSE"

          STATUS=$(echo "$RESPONSE" | jq -r '.quizStatus.status')
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Create quiz (only if NOT_CREATED or FAILED)
        if: steps.check-status.outputs.status == 'NOT_CREATED' || steps.check-status.outputs.status == 'FAILED'
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SHA: ${{ github.event.pull_request.head.sha }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          OIDC_TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=tu-backend" \
            | jq -r '.value')

          curl -s -X POST https://more-rationally-fawn.ngrok-free.app/api/quiz \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -H "x-llm-api-key: $OPENAI_API_KEY" \
            -d '{
              "organization": "'"$OWNER"'",
              "repository": "'"$REPO_NAME"'",
              "pullRequest": '"$PR_NUMBER"',
              "sha": "'"$SHA"'"
            }'

      - name: Finish workflow
        run: |
          echo "Workflow finished. Merge decision is controlled by the GitHub Check Run."
